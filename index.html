<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Binomial p‑value Demo</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#111821; --ink:#e8eef6; --muted:#9bb0c9; --accent:#3ba8ff; --accent-2:#7cdb90; --warn:#ff7b7b;
    }
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px 40px}
    .header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:20px; margin:0; font-weight:700; letter-spacing:0.2px}
    .card{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls{display:grid; grid-template-columns:repeat(6, minmax(120px, 1fr)); gap:12px}
    .control{background:#0d131b; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px}
    .control label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .control input[type="number"], .control select{width:100%}
    input, select{background:#0b1118; color:var(--ink); border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:8px 10px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .pill{padding:8px 12px; border-radius:999px; background:#0b1118; border:1px solid rgba(255,255,255,.08); cursor:pointer}
    .pill:hover{border-color:var(--accent)}
    .stat{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px}
    .stat .box{background:#0d131b; border:1px solid rgba(255,255,255,.06); padding:10px; border-radius:12px}
    .box h3{margin:0; font-size:12px; color:var(--muted)}
    .box p{margin:6px 0 0; font-size:16px; font-weight:700}
    .legend{display:flex; gap:12px; align-items:center; flex-wrap:wrap; font-size:12px; margin:6px 0}
    .swatch{width:12px; height:12px; border-radius:2px; display:inline-block; margin-right:6px}
    .help{color:var(--muted); font-size:13px; line-height:1.5}
    .footer{margin-top:16px; font-size:12px; color:var(--muted)}
    @media (max-width: 980px){ .controls{grid-template-columns:repeat(2, minmax(120px, 1fr))} }
    canvas{width:100%; height:300px; max-height:600px}
    details{margin-top:16px}
    details pre{background:#0b1118; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Binomial p‑value Playground</h1>
      <div class="row">
        <button class="pill" id="btnEx7">Load badminton 7/10</button>
        <button class="pill" id="btnEx1">Load badminton 1/10</button>
        <button class="pill" id="btnShare">Copy shareable link</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <div class="controls">
        <div class="control">
          <label>Null success rate, p₀ (%)</label>
          <input id="p0" type="number" min="0" max="100" step="0.1" value="80" />
        </div>
        <div class="control">
          <label>Sample size, n</label>
          <input id="n" type="number" min="1" max="1000" step="1" value="10" />
        </div>
        <div class="control">
          <label>Observed successes, k</label>
          <input id="k" type="number" min="0" max="10" step="1" value="7" />
        </div>
        <div class="control">
          <label>Significance, α</label>
          <input id="alpha" type="number" min="0.0001" max="0.5" step="0.0001" value="0.05" />
        </div>
        <div class="control">
          <label>Test</label>
          <select id="test">
            <option value="two">Two‑sided (H₁: p ≠ p₀)</option>
            <option value="left">Left‑tailed (H₁: p &lt; p₀)</option>
            <option value="right">Right‑tailed (H₁: p &gt; p₀)</option>
          </select>
        </div>
        <div class="control">
          <label>Continuity correction (normal)</label>
          <select id="cc">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="stat">
        <div class="box"><h3>Exact p‑value</h3><p id="pExact">—</p></div>
        <div class="box"><h3>Normal approx p‑value</h3><p id="pNorm">—</p></div>
        <div class="box"><h3>Critical region</h3><p id="crit">—</p></div>
        <div class="box"><h3>Decision at α</h3><p id="decision">—</p></div>
      </div>
    </div>

    <div class="card">
      <div class="legend">
        <span class="swatch" style="background:#3ba8ff"></span> Binomial PMF
        <span class="swatch" style="background:#7cdb90"></span> Normal curve (approx)
        <span class="swatch" style="background:#ff7b7b"></span> Rejection region(s)
      </div>
      <canvas id="chart" height="240"></canvas>
      <div class="help" style="margin-top:8px">
        This tool shows the exact binomial distribution for X∼Bin(n, p₀). Bars highlight the rejection region(s) for your chosen α and test. The line is the normal approximation using mean n·p₀ and variance n·p₀(1−p₀).
      </div>
    </div>

    <div class="card">
      <details>
        <summary><strong>Self‑tests</strong> (numerical sanity checks)</summary>
        <pre id="testlog">Running…</pre>
        <div class="row"><button class="pill" id="btnRerun">Re‑run tests</button></div>
      </details>
    </div>

    <div class="footer">
      Tip: paste this page’s link into a Notion “/embed” block once you host it (GitHub Pages, Netlify, Vercel, etc.). State is encoded in the URL so you can share presets.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    // ---- Guard against enormous device pixel ratios or container sizes ----
    var MAX_SAFE_CANVAS_AREA = 16 * 1024 * 1024; // 16,777,216 px² – conservative cross-browser cap
    var MAX_DPR_CAP = 2; // limit internal canvas scaling
    function getSafeDPR(canvas){
      var cssW = canvas.clientWidth || 800;
      var cssH = canvas.clientHeight || 300;
      var dpr = Math.min((window.devicePixelRatio || 1), MAX_DPR_CAP);
      var areaCap = Math.sqrt(MAX_SAFE_CANVAS_AREA / Math.max(1, cssW * cssH));
      // ensure at least 1, cap by DPR and by area
      return Math.max(1, Math.min(dpr, areaCap));
    }

    // Optionally set a global default (Chart.js reads this at construction time)
    try { Chart.defaults.devicePixelRatio = Math.min((window.devicePixelRatio || 1), MAX_DPR_CAP); } catch(e) {}

    // -------- Utilities: factorial logs for stable binomial --------
    var logFact = [0]; // log(0!) = 0
    function ensureLogFact(n){ for(var i=logFact.length; i<=n; i++) logFact[i] = logFact[i-1] + Math.log(i); }
    function logChoose(n,k){ if(k<0||k>n) return -Infinity; ensureLogFact(n); return logFact[n] - logFact[k] - logFact[n-k]; }
    function binomPMF(n,p,k){ if(p===0) return k===0 ? 1 : 0; if(p===1) return k===n ? 1 : 0; var ll = logChoose(n,k) + k*Math.log(p) + (n-k)*Math.log(1-p); return Math.exp(ll); }
    function binomCDF(n,p,k){ if(k<0) return 0; if(k>=n) return 1; var s=0; for(var i=0;i<=k;i++) s += binomPMF(n,p,i); return Math.min(1, s); }
    function binomSF(n,p,k){ if(k<=0) return 1; if(k>n) return 0; var s=0; for(var i=k;i<=n;i++) s += binomPMF(n,p,i); return Math.max(0, Math.min(1,s)); }

    // Two‑sided exact p‑value via pmf‑threshold definition
    function pTwoSidedExact(n,p0,k){ var pObs = binomPMF(n,p0,k); var s=0; for(var i=0;i<=n;i++){ var pi=binomPMF(n,p0,i); if(pi<=pObs+1e-15) s+=pi; } return Math.min(1, s); }

    // Critical regions
    function leftCritical(n,p0,alpha){ var K=-1; var cdf=0; for(var k=0;k<=n;k++){ cdf += binomPMF(n,p0,k); if(cdf<=alpha+1e-12) K=k; } return K; }
    function rightCritical(n,p0,alpha){ var tail=0; var K; for(var k=n;k>=0;k--){ tail += binomPMF(n,p0,k); if(tail<=alpha+1e-12) { K=k; } } return (typeof K==='number') ? K : (n+1); }

    // Normal approximation (optionally with continuity correction)
    function normalCDF(z){ var t = 1/(1+0.2316419*Math.abs(z)); var d = Math.exp(-0.5*z*z)/Math.sqrt(2*Math.PI); var p = 1 - d*(0.319381530*t - 0.356563782*Math.pow(t,2) + 1.781477937*Math.pow(t,3) - 1.821255978*Math.pow(t,4) + 1.330274429*Math.pow(t,5)); return z>=0 ? p : 1-p; }
    function pValueNormal(n,p0,k,tail,cc){ if(cc===undefined) cc=true; var mu = n*p0, sd = Math.sqrt(n*p0*(1-p0)); if(sd===0){ return (k===mu?1:0); } var lo = (k-0.5-mu)/sd, hi = (k+0.5-mu)/sd; if(tail==='left') return normalCDF(cc?hi:(k-mu)/sd); if(tail==='right') return 1-normalCDF(cc?lo:(k-mu)/sd); var z = (k-mu)/sd; var p1 = normalCDF(z); var two = 2*Math.min(p1, 1-p1); var zm = (((k+0.5)+(k-0.5))/2 - mu)/sd; var p1cc = normalCDF(zm); var twoCC = 2*Math.min(p1cc, 1-p1cc); return cc?twoCC:two; }

    // Chart setup
    var ctx = document.getElementById('chart').getContext('2d');
    var chart;

    function fmtP(x){ if(!isFinite(x)) return '—'; if(x<1e-6) return x.toExponential(2); if(x<0.001) return x.toExponential(2); return x.toFixed(6).replace(/0+$/,'').replace(/\.$/,''); }

    function buildDatasets(n, p0, kI, test){
      // PMF across 0..n
      var xs = Array.from({length:n+1}, function(_,i){ return i; });
      var pmf = xs.map(function(i){ return binomPMF(n,p0,i); });

      // Critical regions
      var Kleft=-1, Kright=n+1;
      if(test==='left')      Kleft  = leftCritical(n,p0,alpha);
      else if(test==='right')Kright = rightCritical(n,p0,alpha);
      else { Kleft = leftCritical(n,p0,alpha/2); Kright = rightCritical(n,p0,alpha/2); }

      // Normal curve values
      var mu = n*p0, sd = Math.sqrt(n*p0*(1-p0)) || 1;
      var nx = 400, xNorm=[], yNorm=[]; var minX = -0.5, maxX = n+0.5;
      for(var i=0;i<nx;i++){ var x = minX + (maxX-minX)*i/(nx-1); var z = (x-mu)/sd; var y = Math.exp(-0.5*z*z)/(sd*Math.sqrt(2*Math.PI)); xNorm.push(x); yNorm.push(y); }

      var rejectMask = xs.map(function(i){ return ( (test==='left'  && i<=Kleft) || (test==='right' && i>=Kright) || (test==='two' && (i<=Kleft || i>=Kright)) ); });

      var barColours = pmf.map(function(_,i){ return rejectMask[i] ? '#ff7b7b' : '#3ba8ff'; });

      var datasets = [
        { type:'bar',    label:'Binomial PMF', data: pmf, backgroundColor: barColours, borderWidth:0, parsing:false },
        { type:'line',   label:'Normal approx', data: xNorm.map(function(x,idx){ return {x:x, y:yNorm[idx]}; }), parsing:false, borderColor:'#7cdb90', borderWidth:2, tension:0.15, pointRadius:0, yAxisID:'y2' },
        { type:'scatter',label:'Observed k', data:[{x:kI, y:pmf[kI]}], parsing:false, pointRadius:6, pointBackgroundColor:'#e8eef6', pointBorderColor:'#e8eef6', showLine:false }
      ];
      return {xs: xs, pmf: pmf, Kleft: Kleft, Kright: Kright, datasets: datasets};
    }

    function compute(){
      var p0 = Math.max(0, Math.min(1, parseFloat(document.getElementById('p0').value)/100));
      var n  = Math.max(1, Math.min(1000, parseInt(document.getElementById('n').value)));
      var kI = Math.max(0, Math.min(n, parseInt(document.getElementById('k').value)));
      var alpha = Math.max(1e-6, Math.min(0.5, parseFloat(document.getElementById('alpha').value)));
      var test = document.getElementById('test').value;
      var cc = document.getElementById('cc').value==='on';
      document.getElementById('k').max = n;

      // Build datasets & stats
      var b = (function(){
        // we need alpha inside buildDatasets – capture it here for simple closure
        window.alpha = alpha; // (scoped helper; not user-facing)
        return buildDatasets(n, p0, kI, test);
      })();

      // Exact p‑value
      var pExact = (test==='left') ? binomCDF(n,p0,kI) : (test==='right') ? binomSF(n,p0,kI) : pTwoSidedExact(n,p0,kI);
      var pNorm  = pValueNormal(n,p0,kI, (test==='two'?'two':test), cc);

      // Decision text
      var reject=false; var critDesc='—';
      if(test==='left'){ reject = (kI <= b.Kleft); critDesc = (b.Kleft>=0)? ('k ≤ ' + b.Kleft) : 'None (α too small)'; }
      else if(test==='right'){ reject = (kI >= b.Kright); critDesc = (b.Kright<=n)? ('k ≥ ' + b.Kright) : 'None (α too small)'; }
      else { var leftTxt = (b.Kleft>=0)? ('k ≤ ' + b.Kleft) : '—'; var rightTxt = (b.Kright<=n)? ('k ≥ ' + b.Kright) : '—'; reject = (kI<=b.Kleft) || (kI>=b.Kright); critDesc = leftTxt + '  or  ' + rightTxt; }

      document.getElementById('pExact').textContent = fmtP(pExact);
      document.getElementById('pNorm').textContent = fmtP(pNorm);
      document.getElementById('crit').textContent = critDesc;
      document.getElementById('decision').textContent = (reject? 'Reject H₀' : 'Do not reject');

      // Safe DPR handling
      var safeDPR = getSafeDPR(ctx.canvas);

      // Build chart config
      var data = { labels: b.xs, datasets: b.datasets };
      var options = {
        responsive:true,
        maintainAspectRatio:false,
        devicePixelRatio: safeDPR,
        animation:false,
        scales:{
          x:{ type:'linear', min:-0.5, max:n+0.5, grid:{ color:'rgba(255,255,255,.06)' }, ticks:{ stepSize:1, callback:function(v){ return Number.isInteger(v)? v: ''; } } },
          y:{ beginAtZero:true, grid:{ color:'rgba(255,255,255,.06)' }, title:{ display:true, text:'Probability (pmf)' } },
          y2:{ position:'right', display:false }
        },
        plugins:{ legend:{ labels:{ color:'#e8eef6' } }, tooltip:{ callbacks:{ label: function(ctx){ if(ctx.dataset.label==='Normal approx') return 'f(x) ≈ ' + ctx.raw.y.toFixed(4); if(ctx.dataset.label==='Observed k') return 'Observed k = ' + kI; var xi = (ctx.parsed && typeof ctx.parsed.x === 'number') ? ctx.parsed.x : ctx.dataIndex; var prob = (b.pmf[xi] != null) ? b.pmf[xi] : 0; return 'k=' + xi + ', P=' + prob.toFixed(6); } } } }
      };

      // Apply/update chart
      if(chart){
        chart.options.devicePixelRatio = safeDPR;
        chart.data = data; chart.options = options; chart.resize(); chart.update();
      } else {
        chart = new Chart(ctx, {type:'bar', data: data, options: options});
      }

      // Update URL hash for sharing
      var state = new URLSearchParams({p0:(p0*100).toString(), n:n, k:kI, alpha:alpha, test:test, cc: (cc?'1':'0')});
      try { history.replaceState(null, '', '#' + state.toString()); } catch(e) {}
    }

    // Load state from URL (if present)
    function loadFromHash(){ if(!location.hash) return; var p = new URLSearchParams(location.hash.slice(1)); if(p.has('p0')) document.getElementById('p0').value = Number(p.get('p0')); if(p.has('n'))  document.getElementById('n').value  = Number(p.get('n')); if(p.has('k'))  document.getElementById('k').value  = Number(p.get('k')); if(p.has('alpha')) document.getElementById('alpha').value = Number(p.get('alpha')); if(p.has('test')) document.getElementById('test').value = p.get('test'); if(p.has('cc')) document.getElementById('cc').value = (p.get('cc')==='1')?'on':'off'; }

    // Self‑tests (no external libs)
    function approxEq(a,b,eps){ return Math.abs(a-b) <= eps; }
    function log(line){ var el=document.getElementById('testlog'); el.textContent += '\n' + line; }
    function clearLog(){ var el=document.getElementById('testlog'); el.textContent=''; }
    function runTests(){
      clearLog(); var pass=true; function t(name, ok){ log((ok?'✅ ':'❌ ') + name); if(!ok) pass=false; }

      // Existing tests (unchanged)
      t('pmf(10,0.8,1) ≈ 4.096e-06', approxEq(binomPMF(10,0.8,1), 4.096e-06, 1e-10));
      t('cdf(10,0.8,7) ≈ 0.3222004736', approxEq(binomCDF(10,0.8,7), 0.3222004736, 1e-12));
      t('pTwoSidedExact(10,0.8,7) ≈ 0.429574656', approxEq(pTwoSidedExact(10,0.8,7), 0.429574656, 5e-13));
      t('pTwoSidedExact(10,0.8,1) ≈ 4.1984e-06', approxEq(pTwoSidedExact(10,0.8,1), 4.1984e-06, 1e-12));
      t('leftCritical(10,0.8,0.05) = 5', leftCritical(10,0.8,0.05) === 5);
      t('leftCritical(10,0.8,0.025) = 4', leftCritical(10,0.8,0.025) === 4);
      t('rightCritical(10,0.8,0.025) = 11', rightCritical(10,0.8,0.025) === 11);
      t('pmf(10,1,10)=1', binomPMF(10,1,10) === 1);
      t('pmf(10,0,0)=1', binomPMF(10,0,0) === 1);

      // Additional tests
      // 8) PMF sums to ~1
      var s=0; for(var i=0;i<=10;i++) s+=binomPMF(10,0.8,i); t('∑ pmf(10,0.8,k) ≈ 1', approxEq(s,1,1e-12));
      // 9) Survival vs CDF identity: P(X≥k) = 1 - P(X≤k-1)
      t('sf ≈ 1 - cdf(k-1)', approxEq(binomSF(10,0.8,6), 1 - binomCDF(10,0.8,5), 1e-12));
      // 10) CDF at n is 1
      t('cdf(10,0.8,10) = 1', binomCDF(10,0.8,10) === 1);

      log('\n' + (pass? 'All tests passed ✅' : 'Some tests failed ❌'));
    }

    // Wire up controls
    ;['p0','n','k','alpha','test','cc'].forEach(function(id){ document.getElementById(id).addEventListener('input', compute); document.getElementById(id).addEventListener('change', compute); });

    document.getElementById('btnEx7').addEventListener('click', function(){ document.getElementById('p0').value = 80; document.getElementById('n').value = 10; document.getElementById('k').value = 7; document.getElementById('alpha').value = 0.05; document.getElementById('test').value='two'; compute(); });
    document.getElementById('btnEx1').addEventListener('click', function(){ document.getElementById('p0').value = 80; document.getElementById('n').value = 10; document.getElementById('k').value = 1; document.getElementById('alpha').value = 0.05; document.getElementById('test').value='two'; compute(); });
    document.getElementById('btnShare').addEventListener('click', function(){ try{ navigator.clipboard.writeText(location.href).then(function(){ alert('Link copied! Paste into a Notion embed.'); }); } catch(e){ alert('Copy failed. Manually copy the URL.'); } });

    document.getElementById('btnRerun').addEventListener('click', runTests);

    window.addEventListener('resize', compute);

    loadFromHash();
    compute();
    runTests();
  </script>
</body>
</html>
